{{define "content"}}
<div class="row mb-4">
    <div class="col-md-12">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
            Add Client
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h2 class="card-title">Clients</h2>
        <div class="table-responsive mt-4">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>VAT ID</th>
                        <th>Company Number</th>
                        <th>Address</th>
                        <th>City</th>
                        <th>Postal Code</th>
                        <th>Country</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clientsTableBody">
                    {{range .Clients}}
                    <tr>
                        <td>{{.Name}}</td>
                        <td>{{.VatID}}</td>
                        <td>{{.CompanyNumber}}</td>
                        <td>{{.Address}}</td>
                        <td>{{.City}}</td>
                        <td>{{.PostalCode}}</td>
                        <td>{{.Country}}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-client" data-id="{{.ID}}">Edit</button>
                        </td>
                    </tr>
                    {{else}}
                    <tr>
                        <td colspan="8" class="text-center">No clients found</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addClientModalLabel">Add Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <input type="hidden" id="clientId" value="0">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="vatId" class="form-label">VAT ID</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="vatId" name="vatId" required>
                                <button class="btn btn-outline-secondary" type="button" id="lookupVatBtn">Lookup</button>
                            </div>
                            <div class="form-text">Enter VAT ID to automatically fetch client details</div>
                        </div>
                        <div class="col-md-6">
                            <label for="companyNumber" class="form-label">Company Number</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="companyNumber" name="companyNumber" placeholder="e.g. 12345678">
                                <button class="btn btn-outline-secondary" type="button" id="lookupCompanyNumberBtn">Lookup</button>
                            </div>
                            <div class="form-text">Company registration number (optional)</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="companyName" class="form-label">UK Company Name</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="companyName" name="companyName">
                                <button class="btn btn-outline-secondary" type="button" id="lookupCompanyBtn">Lookup</button>
                            </div>
                            <div class="form-text">For UK companies - enter company name to lookup</div>
                        </div>
                        <div class="col-md-6">
                            <label for="name" class="form-label">Client Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="address" name="address" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="city" class="form-label">City</label>
                            <input type="text" class="form-control" id="city" name="city" required>
                        </div>
                        <div class="col-md-4">
                            <label for="postalCode" class="form-label">Postal Code</label>
                            <input type="text" class="form-control" id="postalCode" name="postalCode" required>
                        </div>
                        <div class="col-md-4">
                            <label for="country" class="form-label">Country</label>
                            <input type="text" class="form-control" id="country" name="country" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveClientBtn">Save Client</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const clientForm = document.getElementById('clientForm');
    const saveClientBtn = document.getElementById('saveClientBtn');
    const lookupVatBtn = document.getElementById('lookupVatBtn');
    const lookupCompanyBtn = document.getElementById('lookupCompanyBtn');
    const lookupCompanyNumberBtn = document.getElementById('lookupCompanyNumberBtn');
    const clientModal = new bootstrap.Modal(document.getElementById('addClientModal'));
    
    // Edit client buttons
    document.querySelectorAll('.edit-client').forEach(button => {
        button.addEventListener('click', function() {
            const clientId = this.getAttribute('data-id');
            fetchClient(clientId);
        });
    });
    
    // VAT lookup
    lookupVatBtn.addEventListener('click', function() {
        const vatId = document.getElementById('vatId').value;
        if (!vatId) {
            alert('Please enter a VAT ID');
            return;
        }
        
        fetch(`/api/clients/vat-lookup?vat_id=${encodeURIComponent(vatId)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('VAT ID lookup failed');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('name').value = data.name || '';
                document.getElementById('address').value = data.address || '';
                document.getElementById('city').value = data.city || '';
                document.getElementById('postalCode').value = data.postal_code || '';
                document.getElementById('country').value = data.country || '';
                document.getElementById('companyNumber').value = data.company_number || '';
            })
            .catch(error => {
                console.error('Error looking up VAT ID:', error);
                alert('Error looking up VAT ID: ' + error.message);
            });
    });
    
    // Company name lookup (UK only)
    lookupCompanyBtn.addEventListener('click', function() {
        const companyName = document.getElementById('companyName').value;
        if (!companyName) {
            alert('Please enter a company name');
            return;
        }
        
        fetch(`/api/clients/vat-lookup?company_name=${encodeURIComponent(companyName)}`)
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Company lookup failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('name').value = data.name || '';
                document.getElementById('address').value = data.address || '';
                document.getElementById('city').value = data.city || '';
                document.getElementById('postalCode').value = data.postal_code || '';
                document.getElementById('country').value = data.country || '';
                document.getElementById('vatId').value = data.vat_id || '';
                document.getElementById('companyNumber').value = data.company_number || '';
            })
            .catch(error => {
                console.error('Error looking up company:', error);
                alert('Error looking up company: ' + error.message);
            });
    });
    
    // Company number lookup
    lookupCompanyNumberBtn.addEventListener('click', function() {
        const companyNumber = document.getElementById('companyNumber').value;
        if (!companyNumber) {
            alert('Please enter a company number');
            return;
        }
        
        fetch(`/api/clients/vat-lookup?company_number=${encodeURIComponent(companyNumber)}`)
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Company lookup failed');
                    });
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('name').value = data.name || '';
                document.getElementById('address').value = data.address || '';
                document.getElementById('city').value = data.city || '';
                document.getElementById('postalCode').value = data.postal_code || '';
                document.getElementById('country').value = data.country || '';
                document.getElementById('vatId').value = data.vat_id || '';
                document.getElementById('companyNumber').value = data.company_number || '';
            })
            .catch(error => {
                console.error('Error looking up company:', error);
                alert('Error looking up company: ' + error.message);
            });
    });
    
    // Save client
    saveClientBtn.addEventListener('click', function() {
        saveClient(false);
    });
    
    // Function to save client with option to skip validation
    function saveClient(skipValidation) {
        if (!clientForm.checkValidity()) {
            clientForm.reportValidity();
            return;
        }
        
        const client = {
            id: parseInt(document.getElementById('clientId').value) || 0,
            name: document.getElementById('name').value,
            address: document.getElementById('address').value,
            city: document.getElementById('city').value,
            postal_code: document.getElementById('postalCode').value,
            country: document.getElementById('country').value,
            vat_id: document.getElementById('vatId').value,
            company_number: document.getElementById('companyNumber').value
        };
        
        // Determine the URL based on whether to skip validation
        const url = skipValidation ? '/api/clients?skip_vat_validation=true' : '/api/clients';
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(client)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    // If it's a JSON response, use the structured error
                    if (data && data.error) {
                        throw { 
                            status: response.status, 
                            error: data.error, 
                            message: data.message || response.statusText 
                        };
                    }
                    // Otherwise fall back to text
                    throw new Error(response.statusText);
                }).catch(e => {
                    // If JSON parsing fails, try to get text
                    if (e instanceof SyntaxError) {
                        return response.text().then(text => {
                            throw new Error(text || response.statusText);
                        });
                    }
                    throw e;
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Client saved:', data);
            alert('Client saved successfully!');
            clientModal.hide();
            window.location.reload();
        })
        .catch(error => {
            console.error('Error saving client:', error);
            
            // Check if it's a VAT service unavailability error
            if (error.error === 'VAT_SERVICE_UNAVAILABLE') {
                const confirmSkip = confirm(
                    'The VAT validation service is currently unavailable:\n\n' + 
                    error.message + '\n\n' + 
                    'Would you like to save the client without VAT validation?'
                );
                
                if (confirmSkip) {
                    // Try again with validation skipped
                    saveClient(true);
                }
                return;
            }
            
            // Check if the error is related to VAT ID validation
            const errorMessage = error.message || '';
            if (errorMessage.includes('Invalid VAT ID')) {
                alert('Error: ' + errorMessage + '\n\nPlease verify the VAT ID is correct or use the VAT ID lookup button to validate it.');
                document.getElementById('vatId').focus();
            } else {
                alert('Error saving client: ' + errorMessage);
            }
        });
    }
    
    // Fetch client for editing
    function fetchClient(id) {
        console.log(`Attempting to fetch client with ID: ${id}`);
        fetch(`/api/clients/${id}`)
            .then(response => {
                if (!response.ok) {
                    console.error(`Server returned status: ${response.status} ${response.statusText}`);
                    return response.text().then(text => {
                        throw new Error(`Failed to fetch client (${response.status}): ${text || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log(`Successfully fetched client: ${data.name}`);
                document.getElementById('clientId').value = data.id;
                document.getElementById('name').value = data.name;
                document.getElementById('address').value = data.address;
                document.getElementById('city').value = data.city;
                document.getElementById('postalCode').value = data.postal_code;
                document.getElementById('country').value = data.country;
                document.getElementById('vatId').value = data.vat_id;
                document.getElementById('companyNumber').value = data.company_number;
                document.getElementById('companyName').value = '';
                
                document.getElementById('addClientModalLabel').textContent = 'Edit Client';
                clientModal.show();
            })
            .catch(error => {
                console.error('Error fetching client:', error);
                alert('Error fetching client: ' + error.message);
            });
    }
    
    // Reset form when modal is closed
    document.getElementById('addClientModal').addEventListener('hidden.bs.modal', function() {
        clientForm.reset();
        document.getElementById('clientId').value = '0';
        document.getElementById('addClientModalLabel').textContent = 'Add Client';
    });
});
</script>
{{end}} 