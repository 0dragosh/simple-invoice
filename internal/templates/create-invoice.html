{{define "content"}}
<div class="card">
    <div class="card-body">
        <h2 class="card-title">Create Invoice</h2>
        <form id="invoiceForm" class="mt-4">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="invoiceNumber" class="form-label">Invoice Number</label>
                    <input type="text" class="form-control" id="invoiceNumber" name="invoiceNumber" required>
                </div>
                <div class="col-md-4">
                    <label for="issueDate" class="form-label">Issue Date</label>
                    <input type="date" class="form-control" id="issueDate" name="issueDate" value="{{.IssueDate}}" required>
                </div>
                <div class="col-md-4">
                    <label for="dueDate" class="form-label">Due Date</label>
                    <input type="date" class="form-control" id="dueDate" name="dueDate" value="{{.DueDate}}" required>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="clientId" class="form-label">Client</label>
                    <select class="form-select" id="clientId" name="clientId" required>
                        <option value="">Select Client</option>
                        {{range .Clients}}
                        <option value="{{.ID}}" data-country="{{.Country}}">{{.Name}} ({{.VatID}})</option>
                        {{end}}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="businessId" class="form-label">Business</label>
                    <select class="form-select" id="businessId" name="businessId" data-country="{{.Business.Country}}" required>
                        <option value="{{.Business.ID}}" selected>{{.Business.Name}} ({{.Business.VatID}})</option>
                    </select>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="hourlyRate" class="form-label">Hourly Rate</label>
                    <input type="number" class="form-control" id="hourlyRate" name="hourlyRate" step="0.01" min="0" required>
                </div>
                <div class="col-md-4">
                    <label for="hoursWorked" class="form-label">Hours Worked</label>
                    <input type="number" class="form-control" id="hoursWorked" name="hoursWorked" step="0.01" min="0" value="{{.WorkHours}}" required>
                </div>
                <div class="col-md-2">
                    <label for="vatRate" class="form-label">VAT Rate (%)</label>
                    <input type="number" class="form-control" id="vatRate" name="vatRate" step="0.1" min="0" value="19" required>
                </div>
                <div class="col-md-2">
                    <label for="currency" class="form-label">Currency</label>
                    <select class="form-select" id="currency" name="currency">
                        <option value="EUR" selected>EUR (€)</option>
                        <option value="GBP">GBP (£)</option>
                        <option value="BGN">BGN (лв)</option>
                        <option value="HRK">HRK (kn)</option>
                        <option value="CZK">CZK (Kč)</option>
                        <option value="DKK">DKK (kr)</option>
                        <option value="HUF">HUF (Ft)</option>
                        <option value="PLN">PLN (zł)</option>
                        <option value="RON">RON (lei)</option>
                        <option value="SEK">SEK (kr)</option>
                        <option value="USD">USD ($)</option>
                        <option value="CHF">CHF (Fr)</option>
                    </select>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="reverseChargeVat" name="reverseChargeVat">
                        <label class="form-check-label" for="reverseChargeVat">
                            Reverse Charge VAT
                        </label>
                    </div>
                </div>
            </div>
            
            <h3 class="mt-4">Invoice Items</h3>
            <div id="invoiceItems">
                <div class="invoice-item card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Description</label>
                                <input type="text" class="form-control item-description" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control item-quantity" step="0.01" min="0" value="1" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Unit Price</label>
                                <input type="number" class="form-control item-price" step="0.01" min="0" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control item-amount" step="0.01" min="0" readonly>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-12">
                    <button type="button" class="btn btn-secondary" id="addItemBtn">Add Item</button>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6 offset-md-6">
                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-6">Subtotal:</div>
                                <div class="col-6 text-end" id="subtotal">0.00</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6">VAT:</div>
                                <div class="col-6 text-end" id="vat">0.00</div>
                            </div>
                            <div class="row">
                                <div class="col-6"><strong>Total:</strong></div>
                                <div class="col-6 text-end"><strong id="total">0.00</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Create Invoice</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const invoiceForm = document.getElementById('invoiceForm');
    const addItemBtn = document.getElementById('addItemBtn');
    const invoiceItems = document.getElementById('invoiceItems');
    const hourlyRateInput = document.getElementById('hourlyRate');
    const hoursWorkedInput = document.getElementById('hoursWorked');
    const vatRateInput = document.getElementById('vatRate');
    const currencySelect = document.getElementById('currency');
    const reverseChargeVatCheckbox = document.getElementById('reverseChargeVat');
    const clientSelect = document.getElementById('clientId');
    const submitBtn = document.querySelector('button[type="submit"]');
    let isSubmitting = false; // Flag to prevent duplicate submissions
    
    // Ensure EUR is selected by default
    currencySelect.value = 'EUR';
    
    // Generate invoice number (YYYY-MM-XXXX)
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const random = Math.floor(1000 + Math.random() * 9000);
    document.getElementById('invoiceNumber').value = `${year}-${month}-${random}`;
    
    // Add invoice item
    addItemBtn.addEventListener('click', function() {
        addInvoiceItem(false); // false means it's not the first item
    });
    
    // Initial invoice item - only create one by default
    addInvoiceItem(true); // true means it's the first item
    
    // Map of country codes to currencies
    const countryCurrencyMap = {
        // Eurozone countries
        'AT': 'EUR', 'BE': 'EUR', 'CY': 'EUR', 'EE': 'EUR', 'FI': 'EUR',
        'FR': 'EUR', 'DE': 'EUR', 'GR': 'EUR', 'IE': 'EUR', 'IT': 'EUR',
        'LV': 'EUR', 'LT': 'EUR', 'LU': 'EUR', 'MT': 'EUR', 'NL': 'EUR',
        'PT': 'EUR', 'SK': 'EUR', 'SI': 'EUR', 'ES': 'EUR',
        
        // Non-Eurozone EU countries
        'BG': 'BGN', 'HR': 'HRK', 'CZ': 'CZK', 'DK': 'DKK',
        'HU': 'HUF', 'PL': 'PLN', 'RO': 'RON', 'SE': 'SEK',
        
        // Former EU member
        'GB': 'GBP',
        
        // Default to EUR for other countries
        'default': 'EUR'
    };
    
    document.getElementById('clientId').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const clientCountry = selectedOption.getAttribute('data-country');
        
        if (clientCountry) {
            const currency = countryCurrencyMap[clientCountry] || countryCurrencyMap['default'];
            document.getElementById('currency').value = currency;
            
            // Check if the client is from the EU
            const isEUClient = Object.keys(countryCurrencyMap).includes(clientCountry);
            
            // If client is from a different EU country than the business, suggest reverse charge VAT
            const businessCountry = document.getElementById('businessId').getAttribute('data-country');
            if (isEUClient && clientCountry !== businessCountry) {
                document.getElementById('reverseChargeVat').checked = true;
            } else {
                document.getElementById('reverseChargeVat').checked = false;
            }
        }
    });
    
    // Update calculations when inputs change
    invoiceForm.addEventListener('input', function(e) {
        if (e.target.classList.contains('item-quantity') || 
            e.target.classList.contains('item-price') ||
            e.target.id === 'hourlyRate' ||
            e.target.id === 'hoursWorked' ||
            e.target.id === 'vatRate' ||
            e.target.id === 'currency' ||
            e.target.id === 'reverseChargeVat') {
            updateCalculations();
        }
    });
    
    // Handle client selection change to check for reverse charge VAT
    clientSelect.addEventListener('change', function() {
        checkReverseChargeVat();
    });
    
    // Check if reverse charge VAT should be applied
    function checkReverseChargeVat() {
        const clientId = clientSelect.value;
        if (!clientId) return;
        
        // Get the selected client's country
        const selectedOption = clientSelect.options[clientSelect.selectedIndex];
        const clientCountry = selectedOption.getAttribute('data-country');
        
        // Get the business country
        const businessCountry = document.getElementById('businessId').getAttribute('data-country');
        
        // If countries are different, enable reverse charge VAT
        if (clientCountry && businessCountry && clientCountry !== businessCountry) {
            reverseChargeVatCheckbox.checked = true;
        } else {
            reverseChargeVatCheckbox.checked = false;
        }
        
        // Update calculations
        updateCalculations();
    }
    
    // Hourly rate and hours worked should update the first item
    hourlyRateInput.addEventListener('input', function() {
        const firstItemPrice = document.querySelector('.invoice-item:first-child .item-price');
        if (firstItemPrice) {
            firstItemPrice.value = this.value;
            updateItemAmount(firstItemPrice.closest('.invoice-item'));
            updateCalculations();
        }
    });
    
    hoursWorkedInput.addEventListener('input', function() {
        const firstItemQuantity = document.querySelector('.invoice-item:first-child .item-quantity');
        if (firstItemQuantity) {
            firstItemQuantity.value = this.value;
            updateItemAmount(firstItemQuantity.closest('.invoice-item'));
            updateCalculations();
        }
    });
    
    // Add a direct click event listener to the submit button
    submitBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation(); // Stop event propagation to prevent form submission
        console.log('Submit button clicked directly');
        if (!isSubmitting) {
            submitInvoice();
        }
    });
    
    // Validate the invoice form
    function validateInvoiceForm() {
        // Check client
        const clientId = document.getElementById('clientId').value;
        if (!clientId || clientId === '0') {
            alert('Please select a client');
            document.getElementById('clientId').focus();
            return false;
        }
        
        // Check business
        const businessId = document.getElementById('businessId').value;
        if (!businessId || businessId === '0') {
            alert('Business information is missing');
            return false;
        }
        
        // Check invoice number
        const invoiceNumber = document.getElementById('invoiceNumber').value;
        if (!invoiceNumber) {
            alert('Please enter an invoice number');
            document.getElementById('invoiceNumber').focus();
            return false;
        }
        
        // Check dates
        const issueDate = document.getElementById('issueDate').value;
        if (!issueDate) {
            alert('Please enter an issue date');
            document.getElementById('issueDate').focus();
            return false;
        }
        
        const dueDate = document.getElementById('dueDate').value;
        if (!dueDate) {
            alert('Please enter a due date');
            document.getElementById('dueDate').focus();
            return false;
        }
        
        // Check invoice items
        const items = document.querySelectorAll('.invoice-item');
        if (items.length === 0) {
            alert('Please add at least one invoice item');
            return false;
        }
        
        let hasValidItems = false;
        items.forEach(item => {
            const description = item.querySelector('.item-description').value;
            const quantity = item.querySelector('.item-quantity').value;
            const unitPrice = item.querySelector('.item-price').value;
            
            if (description && quantity && unitPrice) {
                hasValidItems = true;
            }
        });
        
        if (!hasValidItems) {
            alert('Please add at least one valid invoice item with description, quantity, and price');
            return false;
        }
        
        return true;
    }
    
    // Add invoice item function
    function addInvoiceItem(isFirstItem) {
        // If it's not the first item and we already have items, clone the template
        if (!isFirstItem && document.querySelectorAll('.invoice-item').length > 0) {
            const itemTemplate = document.querySelector('.invoice-item').cloneNode(true);
            
            // Clear values for new items
            itemTemplate.querySelector('.item-description').value = '';
            itemTemplate.querySelector('.item-quantity').value = '1';
            itemTemplate.querySelector('.item-price').value = '';
            itemTemplate.querySelector('.item-amount').value = '';
            
            // Add name attributes to form elements for proper form submission
            const itemIndex = document.querySelectorAll('.invoice-item').length;
            itemTemplate.querySelector('.item-description').name = `item_description_${itemIndex}`;
            itemTemplate.querySelector('.item-quantity').name = `item_quantity_${itemIndex}`;
            itemTemplate.querySelector('.item-price').name = `item_price_${itemIndex}`;
            itemTemplate.querySelector('.item-amount').name = `item_amount_${itemIndex}`;
            
            // Add remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-danger btn-sm position-absolute top-0 end-0 m-2';
            removeBtn.innerHTML = '&times;';
            removeBtn.addEventListener('click', function() {
                this.closest('.invoice-item').remove();
                updateCalculations();
            });
            
            itemTemplate.querySelector('.card-body').style.position = 'relative';
            itemTemplate.querySelector('.card-body').appendChild(removeBtn);
            
            // Add event listeners for calculations
            itemTemplate.querySelector('.item-quantity').addEventListener('input', function() {
                updateItemAmount(this.closest('.invoice-item'));
                updateCalculations();
            });
            
            itemTemplate.querySelector('.item-price').addEventListener('input', function() {
                updateItemAmount(this.closest('.invoice-item'));
                updateCalculations();
            });
            
            invoiceItems.appendChild(itemTemplate);
            updateCalculations();
        } 
        // For the first item, just set up the existing template
        else if (isFirstItem) {
            const firstItem = document.querySelector('.invoice-item');
            if (firstItem) {
                // For the first item, set description to "Consulting Services"
                firstItem.querySelector('.item-description').value = 'Consulting Services';
                
                // Add name attributes to form elements for proper form submission
                firstItem.querySelector('.item-description').name = 'item_description_0';
                firstItem.querySelector('.item-quantity').name = 'item_quantity_0';
                firstItem.querySelector('.item-price').name = 'item_price_0';
                firstItem.querySelector('.item-amount').name = 'item_amount_0';
                
                // If hourly rate and hours worked are set, use them
                if (hourlyRateInput.value) {
                    firstItem.querySelector('.item-price').value = hourlyRateInput.value;
                }
                
                if (hoursWorkedInput.value) {
                    firstItem.querySelector('.item-quantity').value = hoursWorkedInput.value;
                }
                
                updateItemAmount(firstItem);
                updateCalculations();
                
                // Add event listeners for calculations
                firstItem.querySelector('.item-quantity').addEventListener('input', function() {
                    updateItemAmount(this.closest('.invoice-item'));
                    updateCalculations();
                });
                
                firstItem.querySelector('.item-price').addEventListener('input', function() {
                    updateItemAmount(this.closest('.invoice-item'));
                    updateCalculations();
                });
            }
        }
    }
    
    // Update item amount
    function updateItemAmount(item) {
        const quantity = parseFloat(item.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(item.querySelector('.item-price').value) || 0;
        const amount = quantity * price;
        item.querySelector('.item-amount').value = amount.toFixed(2);
    }
    
    // Update calculations
    function updateCalculations() {
        let subtotal = 0;
        
        document.querySelectorAll('.invoice-item').forEach(item => {
            updateItemAmount(item);
            subtotal += parseFloat(item.querySelector('.item-amount').value) || 0;
        });
        
        const vatRate = parseFloat(vatRateInput.value) || 0;
        const reverseChargeVat = reverseChargeVatCheckbox.checked;
        const vatAmount = reverseChargeVat ? 0 : (subtotal * vatRate / 100);
        const total = subtotal + vatAmount;
        const currency = currencySelect.value;
        
        document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' ' + currency;
        document.getElementById('vat').textContent = vatAmount.toFixed(2) + ' ' + currency;
        document.getElementById('total').textContent = total.toFixed(2) + ' ' + currency;
        
        // Update labels for unit price and amount
        document.querySelectorAll('.invoice-item').forEach(item => {
            const unitPriceLabel = item.querySelector('.item-price').previousElementSibling;
            const amountLabel = item.querySelector('.item-amount').previousElementSibling;
            
            unitPriceLabel.textContent = 'Unit Price (' + currency + ')';
            amountLabel.textContent = 'Amount (' + currency + ')';
        });
    }
    
    // Function to handle invoice submission
    function submitInvoice() {
        try {
            console.log('Starting invoice submission process');
            
            // Prevent duplicate submissions
            if (isSubmitting) {
                console.log('Already submitting, ignoring duplicate submission');
                return;
            }
            
            isSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
            
            // Validate form
            if (!validateInvoiceForm()) {
                console.log('Form validation failed');
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Invoice';
                return;
            }
            
            try {
                // Get form data
                const formData = new FormData(invoiceForm);
                const clientId = parseInt(formData.get('clientId'));
                const businessId = parseInt(formData.get('businessId'));
                const issueDate = formData.get('issueDate');
                const dueDate = formData.get('dueDate');
                const invoiceNumber = formData.get('invoiceNumber');
                const hourlyRate = parseFloat(formData.get('hourlyRate') || 0);
                const hoursWorked = parseFloat(formData.get('hoursWorked') || 0);
                const vatRate = parseFloat(formData.get('vatRate') || 0);
                const currency = formData.get('currency') || 'EUR';
                const reverseChargeVat = formData.get('reverseChargeVat') === 'on';
                const notes = formData.get('notes');
                
                console.log('Form data collected:', {
                    clientId, businessId, issueDate, dueDate, invoiceNumber,
                    hourlyRate, hoursWorked, vatRate, currency, reverseChargeVat, notes
                });
                
                // Collect invoice items
                const items = [];
                let itemsValid = true;
                
                document.querySelectorAll('.invoice-item').forEach((item, index) => {
                    try {
                        const description = item.querySelector('.item-description').value;
                        const quantity = parseFloat(item.querySelector('.item-quantity').value);
                        const unitPrice = parseFloat(item.querySelector('.item-price').value);
                        const amount = parseFloat(item.querySelector('.item-amount').value);
                        
                        console.log(`Item ${index+1}:`, { description, quantity, unitPrice, amount });
                        
                        if (description && !isNaN(quantity) && !isNaN(unitPrice) && !isNaN(amount)) {
                            items.push({
                                description: description,
                                quantity: quantity,
                                unit_price: unitPrice,
                                amount: amount
                            });
                        } else {
                            console.log(`Item ${index+1} skipped due to invalid data`);
                            if (description) {
                                // If there's a description but other fields are invalid, consider it an error
                                itemsValid = false;
                                console.error(`Item ${index+1} has description but invalid numeric data`);
                            }
                        }
                    } catch (itemError) {
                        console.error(`Error processing item ${index+1}:`, itemError);
                        itemsValid = false;
                    }
                });
                
                console.log('Collected items:', items);
                
                if (items.length === 0) {
                    console.error('No valid items collected');
                    alert('Please add at least one valid invoice item with description, quantity, and price');
                    isSubmitting = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Invoice';
                    return;
                }
                
                if (!itemsValid) {
                    console.error('Some items have invalid data');
                    alert('Some invoice items have invalid data. Please check quantity and price fields.');
                    isSubmitting = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Invoice';
                    return;
                }
                
                // Calculate totals
                const subtotal = items.reduce((sum, item) => sum + item.amount, 0);
                const vatAmount = reverseChargeVat ? 0 : subtotal * (vatRate / 100);
                const totalAmount = subtotal + vatAmount;
                
                // Create invoice object
                const invoice = {
                    invoice: {
                        id: 0, // New invoice
                        invoice_number: invoiceNumber,
                        business_id: businessId,
                        client_id: clientId,
                        issue_date: issueDate,
                        due_date: dueDate,
                        hourly_rate: hourlyRate,
                        hours_worked: hoursWorked,
                        total_amount: totalAmount,
                        vat_rate: vatRate,
                        vat_amount: vatAmount,
                        reverse_charge_vat: reverseChargeVat,
                        currency: currency,
                        notes: notes,
                        status: "Draft"
                    },
                    items: items
                };
                
                console.log('Submitting invoice:', JSON.stringify(invoice));
                
                // Add a timeout to prevent the button from hanging indefinitely
                const submissionTimeout = setTimeout(() => {
                    console.error('Submission timeout reached');
                    isSubmitting = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Invoice';
                    alert('The request is taking too long. Please try again.');
                }, 10000); // 10 second timeout
                
                // Use XMLHttpRequest instead of fetch for better error handling
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/invoices', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onload = function() {
                    clearTimeout(submissionTimeout);
                    console.log('XHR response received:', xhr.status, xhr.statusText);
                    console.log('Response body:', xhr.responseText);
                    
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            console.log('Invoice created:', data);
                            alert('Invoice created successfully!');
                            window.location.href = '/invoices';
                        } catch (e) {
                            console.error('Failed to parse JSON response:', e);
                            console.error('Raw response:', xhr.responseText);
                            alert('Invoice was created but there was an error processing the response. Please check the invoices page.');
                            window.location.href = '/invoices';
                        }
                    } else {
                        console.error(`Server returned status: ${xhr.status} ${xhr.statusText}`);
                        console.error('Response body:', xhr.responseText);
                        alert(`Failed to create invoice (${xhr.status}): ${xhr.responseText || xhr.statusText}`);
                        isSubmitting = false;
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Create Invoice';
                    }
                };
                
                xhr.onerror = function() {
                    clearTimeout(submissionTimeout);
                    console.error('Network error occurred');
                    alert('Network error occurred. Please check your connection and try again.');
                    isSubmitting = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Invoice';
                };
                
                xhr.ontimeout = function() {
                    clearTimeout(submissionTimeout);
                    console.error('Request timed out');
                    alert('Request timed out. Please try again.');
                    isSubmitting = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Invoice';
                };
                
                xhr.send(JSON.stringify(invoice));
                
            } catch (dataError) {
                console.error('Error preparing invoice data:', dataError);
                alert('Error preparing invoice data: ' + dataError.message);
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Invoice';
            }
        } catch (error) {
            console.error('Unhandled error in submitInvoice:', error);
            alert('An unexpected error occurred: ' + error.message);
            isSubmitting = false;
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Invoice';
        }
    }
});
</script>
{{end}} 